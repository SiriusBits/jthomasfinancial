---
import BaseLayout from "@/components/layout/BaseLayout.astro";
import ServiceCard from "@/components/ServiceCard.astro";
import { getEntry, render } from "astro:content";
import {
  Calculator,
  DollarSign,
  FileText,
  Briefcase,
} from "@/icons/lucide-icons";
import { servicesList } from "@/data/services";

const iconMap: Record<string, import("astro").Component> = {
  calculator: Calculator,
  "dollar-sign": DollarSign,
  "file-text": FileText,
  briefcase: Briefcase,
};

const servicesWithContent = await Promise.all(
  servicesList.map(async (service) => {
    const entry = await getEntry("services", service.slug);
    if (!entry) return { service, Content: null };
    const { Content } = await render(entry);
    return { service, Content };
  })
);
---

<BaseLayout
  title="Services â€” J Thomas Financial"
  description="Tax planning, payroll, financial statements, and consulting."
>
  <main class="max-w-6xl mx-auto px-4 py-12">
    <h1 class="font-heading text-navy text-3xl font-semibold mb-2">
      Our Services
    </h1>
    <p class="text-neutral-600 mb-10 max-w-2xl">
      We offer a range of professional finance and accounting services to
      support your business.
    </p>
    <div class="grid gap-6 sm:grid-cols-2">
      {
        servicesWithContent.map(({ service, Content }) => (
          <ServiceCard service={service} icon={iconMap[service.icon]}>
            {Content && <Content slot="expandable" />}
          </ServiceCard>
        ))
      }
    </div>
  </main>
</BaseLayout>

<style is:global>
  [data-accordion-wrapper].is-expanded {
    grid-template-rows: 1fr;
  }
</style>

<script>
  function initServiceAccordions() {
    document.querySelectorAll('.service-accordion').forEach((accordion) => {
      const trigger = accordion.querySelector('[data-accordion-trigger]');
      const wrapper = accordion.querySelector('[data-accordion-wrapper]');
      const triggerText = accordion.querySelector('[data-trigger-text]');
      const chevron = accordion.querySelector('[data-chevron]');

      if (!trigger || !wrapper || !triggerText) return;

      trigger.addEventListener('click', () => {
        const isExpanded = wrapper.classList.contains('is-expanded');

        if (isExpanded) {
          wrapper.classList.remove('is-expanded');
          triggerText.textContent = 'Learn more';
          trigger.setAttribute('aria-expanded', 'false');
          chevron?.classList.remove('rotate-180');
        } else {
          wrapper.classList.add('is-expanded');
          triggerText.textContent = 'Show less';
          trigger.setAttribute('aria-expanded', 'true');
          chevron?.classList.add('rotate-180');
        }
      });
    });

    // Expand accordion from URL hash (e.g. /services#tax-planning)
    const hash = window.location.hash.slice(1);
    if (hash) {
      const target = document.querySelector(`[data-service-id="${hash}"]`);
      if (target) {
        const trigger = target.querySelector('[data-accordion-trigger]');
        trigger?.click();
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
  }

  initServiceAccordions();
</script>
